<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title></title>
    <script src="../../Scripts/jquery-1.9.1.js" type="text/javascript"></script>

    <link href="../../Content/Office.css" rel="stylesheet" type="text/css" />
    <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js" type="text/javascript"></script>

    <!-- To enable offline debugging using a local reference to Office.js, use:                        -->
    <!-- <script src="../../Scripts/Office/MicrosoftAjax.js" type="text/javascript"></script>  -->
    <!-- <script src="../../Scripts/Office/1/office.js" type="text/javascript"></script>  -->
    <!-- The script below is not needed if your browser supports ES6 promises -->
    <script src="https://www.promisejs.org/polyfills/promise-6.0.0.min.js"></script>
    <script src="../../Scripts/workfront.min.js" type="text/javascript"></script>

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css" />

    <!-- To enable offline debugging using a local reference to Office.js, use: -->
    <!-- <script src="../../Scripts/Office/MicrosoftAjax.js" type="text/javascript"></script> -->
    <!-- <script src="../../Scripts/Office/1/office.js" type="text/javascript"></script> -->

    <link href="../App.css" rel="stylesheet" type="text/css" />
    <script src="../App.js" type="text/javascript"></script>

    <link href="Home.css" rel="stylesheet" type="text/css" />
    <script src="Home.js" type="text/javascript"></script>
    <script>
        function doLogin() {
            var mailbox = Office.context.mailbox;
            var itemId = mailbox.item.itemId;
            var headersRequest = getHeadersRequest(itemId);
            var envelope = getSoapEnvelope(headersRequest);
            var res;
            $(".spinner-loader").show("slow");
            mailbox.makeEwsRequestAsync(envelope, function (result) {
                var xmlDoc = $.parseXML(result.value);
                var $xml = $("t\\:InternetMessageHeader[HeaderName^='X-AtTask-']", xmlDoc);
                //var headers = $xml.find("t\\:InternetMessageHeader")
                //.find();
                $xml.each(function () {
                    var header = $(this).attr('HeaderName');
                    var val = $(this).text();
                    res += '\nHeader - ' + header + '     Value - ' + val;
                });
                $("textarea#jsonResponse").val(res);
                $(".spinner-loader").hide("slow");
            });

            var url = $('#url').text;
            var username = $('#username').text;
            var password = $('#password').text;
            var instance = new window.Workfront.Api({ url: url, version: '3.0' });
            instance.login(username, password).then(function (data) {
                var value = data.sessionID;
                $("textarea#jsonResponse").val(value);
            }, console.error);
        }

        function getSoapEnvelope(request) {
            // Wrap an Exchange Web Services request in a SOAP envelope.
            var result =
                '<?xml version="1.0" encoding="utf-8"?>' +
                    '<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"' +
                    '               xmlns:t="http://schemas.microsoft.com/exchange/services/2006/types">' +
                    '  <soap:Header>' +
                    '     <t:RequestServerVersion Version="Exchange2013"/>' +
                    '  </soap:Header>' +
                    '  <soap:Body>' +
                    request +
                    '  </soap:Body>' +
                    '</soap:Envelope>';

            return result;
        }

        function getHeadersRequest(id) {
            // Return a GetItem EWS operation request for the headers of the specified item.
            var result =
                '    <GetItem xmlns="http://schemas.microsoft.com/exchange/services/2006/messages">' +
                    '      <ItemShape>' +
                    '        <t:BaseShape>IdOnly</t:BaseShape>' +
                    '        <t:BodyType>Text</t:BodyType>' +
                    '        <t:AdditionalProperties>' +
                    '            <t:FieldURI FieldURI="item:InternetMessageHeaders"/>' +
                    '        </t:AdditionalProperties>' +
                    '      </ItemShape>' +
                    '      <ItemIds><t:ItemId Id="' + id + '"/></ItemIds>' +
                    '    </GetItem>';

            return result;
        }

        function showspinner() {
            var overlay = $('<div class="overlay">');
            $('body').append(overlay);
        }
    </script>
</head>
<body>
    <div class="container">
        <div>
            <div class="form-group">
                <label for="url">Url</label>
                <input type="text" class="form-control" id="url" placeholder="Url to use for connection to Workfront">
            </div>

            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" class="form-control" id="username" placeholder="Your Workfront login">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="text" class="form-control" id="password" placeholder="Your Workfront password">
            </div>

            <button type="submit" class="btn btn-default" onclick=" doLogin() ">Login</button>

            <div>
                <textarea rows="15" cols="50" id="jsonResponse"></textarea>
            </div>
        </div>
    </div>
</body>
</html>